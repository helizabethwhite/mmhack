<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/px-card/px-card.html">
<link rel="import" href="../../bower_components/collapsable-px-card/collapsable-px-card.html">
<link rel="import" href="../../bower_components/px-dropdown/px-dropdown.html">
<link rel="import" href="../../bower_components/px-chart/px-chart.html">

<dom-module id="block-card-1">
  <template>
    <style>
      #cost-output h2 {
        float: left;
        text-align: center;
        width: 50%;
      }
      #graph {
        clear: left;
      }
      .clear {
        clear: both;
      }
      .dropdown {
        width: 200px;
      }
      .block {
        width: 200px;
        float: left;
        margin-left: 20px;
      }
      #equipment {
        margin-top: 0;
      }
    </style>
    <px-card header-text="Block 1" icon="fa-bolt" chevron="true" on-click="_testLog" on-chevron-hit="_toggleCard">

    <iron-ajax
           id="requestAllAssets"
           method="GET"
           url="gendata.json"
           handle-as="json"
           on-response="handleResponse"
           last-response="{{data}}">

        </iron-ajax>


        <iron-ajax
           auto
           id="requestAllServerAssets"
           method="GET"
           handle-as="json"
           on-response="handleServerResponse"
           last-response="{{serverData}}">
        </iron-ajax>

      <div id="top-info">
        <div id="cost-output">
          <h2>Average Cost: $<span id="cost">1</span>M</h2>
          <h2>Output: <span id="output">1</span>mW</h2>
        </div>
        <div id="graph">
          <!--
          #### Series Object

              <px-chart-series-line id="my-series"
                series-obj-name-key="myName"
                series-obj-data-key="myData">
              </px-chart-series-line>

          ```js
            document.querySelector('#my-series').seriesObj = {
                    myData: [
                        [1397102460000, 11.4403],
                        [1397139660000, 13.1913],
                        [1397177400000, 12.8485],
                        [1397228040000, 10.975]],
                    myName: 'foo'
                };
          -->

          <px-chart height="200" navigator-disabled>
              <px-chart-series-line id="blk1-baseline" series-obj-name-key="block1Baseline" series-obj-data-key="blk1BaselineData">
              <px-chart-series-line id="blk1-new" series-obj-name-key="block1New" series-obj-data-key="blk1NewData">
          </px-chart>
        </div>
      </div>

      <div class="clear">
      </div>
      <div id="collapse" class="collapse-top-margin" hidden="true">
        <h2 id="equipment">Equipment:</h2>

      <div id="gt1-blk1" class="block" >
        <div class="dropdown">
          <px-dropdown id="asset-dropdown" display-value="Gas Turbine - 7IEA">
            <px-dropdown-content extend-dropdown='true'
              extend-dropdown-by='25' max-cont-character-width='10'
              items='[{"key":"Gas Engine 1","val":"Gas Turbine - 7IEA"},{"key":"Gas Engine 2","val":"Gas Turbine - 7FB.04"},
              {"key":"Gas Engine 3","val":"Gas Turbine - 6FA.01"}]'>
            </px-dropdown-content>
          </px-dropdown>
        </div>
        <div id="specs">
        <span class="collapse-span">
          <p class="p-left-column">Average Output: </p>
          <p class="p-right-column" id="average-output">1mW</p>
        </span>
        <span class="collapse-span">
          <p class="p-left-column">Max Output: </p>
          <p class="p-right-column" id="max-output">1mW</p>
        </span>

          <p>Frequency: <span id="frequency">1</span></p>
          <p>Ramp Rate: <span id="ramp-rate">1</span></p>
          <p>Minimum Load: <span id="minimum-load">1</span></p>
          <p>Operating Cost: <span id="operating-cost">1</span>mW</p>
        </div>
      </div>

      <div id="gt2-blk1" class="block" >
        <div class="dropdown">
          <px-dropdown id="asset-dropdown" display-value="Gas Turbine - 7FB.04">
            <px-dropdown-content extend-dropdown='true'
              extend-dropdown-by='25' max-cont-character-width='10'
              items='[{"key":"Gas Engine 1","val":"Gas Turbine - 7IEA"},{"key":"Gas Engine 2","val":"Gas Turbine - 7FB.04"},
              {"key":"Gas Engine 3","val":"Gas Turbine - 6FA.01"}]'>
            </px-dropdown-content>
          </px-dropdown>
        </div>
        <div id="specs">
          <p>Average Output: <span id="average-output">1</span>mW</p>
          <p>Max Output: <span id="max-output">1</span>mW</p>
          <p>Frequency: <span id="frequency">1</span></p>
          <p>Ramp Rate: <span id="ramp-rate">1</span></p>
          <p>Minimum Load: <span id="minimum-load">1</span></p>
          <p>Operating Cost: <span id="operating-cost">1</span>mW</p>
        </div>
      </div>

      <div id="gen1-blk1" class="block" >
        <div class="dropdown">
          <px-dropdown id="asset-dropdown" display-value="Gas Gen - 9H2">
            <px-dropdown-content extend-dropdown='true'
              extend-dropdown-by='25' max-cont-character-width='10'
              items='[{"key":"Generator 1","val":"Gas Gen - 9H2"},{"key":"Generator 2","val":"Gas Gen - 6A2"},{"key":"Generator 3"},
              {"key":"4","val":"Gas Gen - 9A4"}]'>
            </px-dropdown-content>
          </px-dropdown>
        </div>
        <div id="specs">
          <p>Power Factor: <span id="power-factor">1</span></p>
          <p>Operating Cost: <span id="operating-cost">1</span>mW</p>
        </div>
      </div>

      <div class="clear">
      </div>

      <button class="btn btn--primary" on-click="_sendData">Submit</button>
    </div>

    </px-card>
  </template>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script type="text/javascript" language="javascript" src="gendata.json"></script>
  <script>
    Polymer({
      is: 'block-card-1',
      properties: {
        allAssets: {
          type: Object,
          notify: true
        },
        allServerAssets: {
          type: Object,
          notify: true
        },
        powerValsLocal: {
          type: Object,
          notify: true
        },
        powerValsServer: {
          type: Object,
          notify: true
        },
        cost: {
           type: Number,
           notify: true
         },
         output: {
           type: Number,
           notify: true
         },
         block: {
          type: Object,
          notify: true
         }
      },
      getInitialData: function() {

          // grab all assets

          this.$.requestAllAssets.generateRequest(); // leaves results in this.$.assets

          // get corresponding block + asset data
          //this.$.requestBlock.generateRequest(); // leaves results in this.$.block

          // call update functions to show data on the page
      },
      // this function is used to fill the page with proper asset/block data from the db
      setData: function() {
          // get the data from the db
          // set the corresponding page elements
          var blockData = [2,2]; // dummy
          var numAssets = 0;
          for (var asset in blockData) {
            var parentDiv = document.createElement("div");
            parentDiv.id = "asset-" + numAssets; // create overarching div

            // create dropdown
            var dropdown = document.createElement("div");
            dropdown.class = "dropdown";

            // create px-dropdown
            var pxDropdown = document.createElement("px-dropdown");
            //pxDropdown.id = "asset-dropdown-"+numAssets;
            //console.log(pxDropdown.id);
            pxDropdown["display-value"] = "INSERT DATA HERE"; // name the asset // REPLACE THIS WITH DATA


            // add dropdown contents
            var pxDropdownContent = document.createElement("px-dropdown-content");
            pxDropdownContent.items = [{"key":"1","val":"Gas Turbine 1"},{"key":"2","val":"Gas Turbine 2"},{"key":"3","val":"Gas Turbine 3"},
            {"key":"4","val":"Gas Turbine 4"}]; // REPLACE THIS WITH DATA

            pxDropdownContent["extend-dropdown"] = true;

            console.log(pxDropdownContent.items);

            // add all elements to parentDiv
            pxDropdown.appendChild(pxDropdownContent);
            dropdown.appendChild(pxDropdown);
            console.log(dropdown.class);

            parentDiv.appendChild(dropdown);

            var specsDiv = document.createElement("div");
            specsDiv.class = "specs";

            var output = document.createElement("p");
            output.id = "max-output";
            output.innerHTML = "Max Output: " + "blockData.maxOutput";

            var frequency = document.createElement("p");
            frequency.id = "frequency";
            frequency.innerHTML = "Frequency: " + "blockData.frequency";

            var rampRate = document.createElement("p");
            rampRate.id = "ramp-rate";
            rampRate.innerHTML = "Ramp Rate: " + "blockData.rampRate";

            var minLoad = document.createElement("p");
            minLoad.id = "minimum-load";
            minLoad.innerHTML = "Minimum Load: " + "blockData.minLoad";

            // add all p elements to specsDiv
            specsDiv.appendChild(output);
            specsDiv.appendChild(frequency);
            specsDiv.appendChild(rampRate);
            specsDiv.appendChild(minLoad);

            // add specsDiv to parentDiv
            parentDiv.appendChild(specsDiv);

            var h2Div = this.$.equipment;
            // insert parentDiv after h2 "equipment"
            h2Div.parentNode.insertBefore(parentDiv, h2Div.nextSibling);

            numAssets++;
          }
      },
      ready: function() {
        console.log('partpicker-view ready()');
        //Add local timeseries data... needs to be updated to respond to requests
        $(document).ready(function(e) {
          addBaselineSeries(gendata.aggregatedTimeSeriesData.powerVals);
        });
        this.getInitialData();



      },
      _sendData: function() {
        //this.getInitialData();this.getInitialData();

        var selectedGt1 = document.querySelector("#gt1-blk1 div px-dropdown").selectedKey
        != '' ? document.querySelector("#gt1-blk1 div px-dropdown").selectedKey : "Gas Engine 1";
        var selectedGt2 = document.querySelector("#gt2-blk1 div px-dropdown").selectedKey
        != '' ? document.querySelector("#gt2-blk1 div px-dropdown").selectedKey : "Gas Engine 2";
        var selectedGen1 = document.querySelector("#gen1-blk1 div px-dropdown").selectedKey
        != '' ? document.querySelector("#gen1-blk1 div px-dropdown").selectedKey : "Generator 1";

        console.log("getData(" + selectedGt1 + "," + selectedGt2 + "," + selectedGen1 + ")");

        var url = "https://serverapp.run.aws-usw02-pr.ice.predix.io/getBlockData/"
        + selectedGt1 + "/" + selectedGt2 + "/" + selectedGen1;
        this.$.requestAllServerAssets.url = url;
        console.log(url);
        this.$.requestAllServerAssets.generateRequest();


        /*this._updateSpecsGT1(69,70,71,72,73,74);
        this._updateSpecsGT2(2,4,6,8,10,12);
        this._updateSpecsGen1(300,400);
        this._updateBlockCost(200000);
        this._updateBlockOutput(300000);*/
      },
      _updateSpecsGT1: function(averageOutput, maxOutput, frequency, rampRate, minimumLoad, operatingCost) {
        document.querySelector("#gt1-blk1 #specs #average-output").innerHTML = parseFloat(averageOutput).toFixed(2);
        document.querySelector("#gt1-blk1 #specs #max-output").innerHTML = parseFloat(maxOutput).toFixed(2);
        document.querySelector("#gt1-blk1 #specs #frequency").innerHTML = parseFloat(frequency).toFixed(2);
        document.querySelector("#gt1-blk1 #specs #ramp-rate").innerHTML = parseFloat(rampRate).toFixed(2);
        document.querySelector("#gt1-blk1 #specs #minimum-load").innerHTML = parseFloat(minimumLoad).toFixed(2);
        document.querySelector("#gt1-blk1 #specs #operating-cost").innerHTML = parseFloat(operatingCost).toFixed(2);
      },
      _updateSpecsGT2: function(averageOutput, maxOutput, frequency, rampRate, minimumLoad, operatingCost) {
        document.querySelector("#gt2-blk1 #specs #average-output").innerHTML = parseFloat(averageOutput).toFixed(2);
        document.querySelector("#gt2-blk1 #specs #max-output").innerHTML = parseFloat(maxOutput).toFixed(2);
        document.querySelector("#gt2-blk1 #specs #frequency").innerHTML = parseFloat(frequency).toFixed(2);
        document.querySelector("#gt2-blk1 #specs #ramp-rate").innerHTML = parseFloat(rampRate).toFixed(2);
        document.querySelector("#gt2-blk1 #specs #minimum-load").innerHTML = parseFloat(minimumLoad).toFixed(2);
        document.querySelector("#gt2-blk1 #specs #operating-cost").innerHTML = parseFloat(operatingCost).toFixed(2);
      },
      _updateSpecsGen1: function(powerFactor, operatingCost) {
        document.querySelector("#gen1-blk1 #specs #power-factor").innerHTML = parseFloat(powerFactor).toFixed(2);
        document.querySelector("#gen1-blk1 #specs #operating-cost").innerHTML = parseFloat(operatingCost).toFixed(2);
      },
      _updateBlockCost: function(cost) {
        document.querySelector("#cost-output #cost").innerHTML = parseFloat(cost).toFixed(2);
        this.cost = cost;
      },
      _updateBlockOutput: function(output) {
        document.querySelector("#cost-output #output").innerHTML = parseFloat(output).toFixed(2);
        this.output = output;
      },
      _testLog: function() {

      },
      _toggleCard: function() {
        if (document.querySelector("#collapse").hasAttribute("hidden")) {
          document.querySelector("#collapse").removeAttribute("hidden");
        }
        else {
          document.querySelector("#collapse").setAttribute("hidden", "true");
        }
      },
      handleResponse: function (data) { // return function from calling server for allAssets
          this.allAssets = data.detail.response;
          console.log(this.data);
          this._updateSpecsGT1(this.allAssets.avgPowerData[0].avgPower,
                              this.allAssets.maxPowerData[0].maxPower,
                              this.allAssets.frequencyData[0].frequency,
                              this.allAssets.rampRateData[0].rampRate,
                              this.allAssets.minimumLoadData[0].minimumLoad,
                              this.allAssets.operatingCostData[0].operatingCost
                            );
          this._updateSpecsGT2(this.allAssets.avgPowerData[1].avgPower,
                              this.allAssets.maxPowerData[1].maxPower,
                              this.allAssets.frequencyData[1].frequency,
                              this.allAssets.rampRateData[1].rampRate,
                              this.allAssets.minimumLoadData[1].minimumLoad,
                              this.allAssets.operatingCostData[1].operatingCost);
          this._updateSpecsGen1(this.allAssets.powerFactorData[0].powerFactor,
                                this.allAssets.operatingCostData[2].operatingCost);

          var totalBlockCost = this.allAssets.operatingCostData[0].operatingCost
                                + this.allAssets.operatingCostData[1].operatingCost
                                + this.allAssets.operatingCostData[2].operatingCost;
          var totalBlockAverageOutput = this.allAssets.avgPowerData[0].avgPower
                                + this.allAssets.avgPowerData[1].avgPower;
          this._updateBlockCost(totalBlockCost);
          this._updateBlockOutput(totalBlockAverageOutput);
          console.log(data.detail.response);


          this.powerValsLocal = this.allAssets.aggregatedTimeSeriesData.powerVals;
          console.log(this.powerValsLocal);

          this.fire("scoreboard-update");
    },

    handleServerResponse: function (data) { // return function from calling server for allAssets from server
        this.allServerAssets = data.detail.response;
        console.log(this.allServerAssets);

        this._updateSpecsGT1(this.allServerAssets.avgPowerData[0].avgPower,
                            this.allServerAssets.maxPowerData[0].maxPower,
                            this.allServerAssets.frequencyData[0].frequency,
                            this.allServerAssets.rampRateData[0].rampRate,
                            this.allServerAssets.minimumLoadData[0].minimumLoad,
                            this.allServerAssets.operatingCostData[0].operatingCost
                          );
        this._updateSpecsGT2(this.allServerAssets.avgPowerData[1].avgPower,
                            this.allServerAssets.maxPowerData[1].maxPower,
                            this.allServerAssets.frequencyData[1].frequency,
                            this.allServerAssets.rampRateData[1].rampRate,
                            this.allServerAssets.minimumLoadData[1].minimumLoad,
                            this.allServerAssets.operatingCostData[1].operatingCost);
        this._updateSpecsGen1(this.allServerAssets.powerFactorData[0].powerFactor,
                              this.allServerAssets.operatingCostData[2].operatingCost);

        var totalBlockCost = this.allServerAssets.operatingCostData[0].operatingCost
                              + this.allServerAssets.operatingCostData[1].operatingCost
                              + this.allServerAssets.operatingCostData[2].operatingCost;
        var totalBlockAverageOutput = this.allServerAssets.avgPowerData[0].avgPower
                              + this.allServerAssets.avgPowerData[1].avgPower;
        this._updateBlockCost(totalBlockCost);
        this._updateBlockOutput(totalBlockAverageOutput);
        console.log(data.detail.response);

        this.powerValsServer = this.allAssets.aggregatedTimeSeriesData.powerVals;
        console.log(this.powerValsServer);

        this.fire("scoreboard-update");
    }
  }

  );

    function addNewSeries(timeSeries){
      document.querySelector("#blk1-new").seriesObj = {
        blk1NewData: timeSeries,
        block1New: 'New'
      }
    }
    function addBaselineSeries(timeSeries){
      document.querySelector("#blk1-baseline").seriesObj = {
        blk1BaselineData: timeSeries,
        block1Baseline: 'Baseline'
      }
    }
  </script>
</dom-module>
