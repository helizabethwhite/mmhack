<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/px-card/px-card.html">
<link rel="import" href="../../bower_components/collapsable-px-card/collapsable-px-card.html">
<link rel="import" href="../../bower_components/px-dropdown/px-dropdown.html">
<link rel="import" href="../../bower_components/px-chart/px-chart.html">

<dom-module id="block-card-1">

  <template>
    <style>
      #cost-output h2 {
        float: left;
        text-align: center;
        width: 50%;
      }
      #graph {
        clear: left;
      }
      .clear {
        clear: both;
      }
      .dropdown {
        width: 200px;
      }
      .block {
        width: 200px;
        float: left;
        margin-left: 20px;
      }
      #equipment {
        margin-top: 0;
      }
    </style>
    <iron-ajax
           auto
           id="requestAllAssets"
           method="POST"
           url="gendata.json"
           headers='{
                        "Accept" : "application/json",
                        "Accept" : "application/x-www-form-urlencoded",
                        "Authorization" : "Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6ImxlZ2FjeS10b2tlbi1rZXkiLCJ0eXAiOiJKV1QifQ.eyJqdGkiOiI3Nzg4NTYzYTYyZDM0MzQxYTU2ODg4OGJhMjNiZmE0NiIsInN1YiI6ImhhY2thdGhvblVBQSIsInNjb3BlIjpbInRpbWVzZXJpZXMuem9uZXMuM2JjNDhmNzAtMTUxOS00YjI3LWE3MTMtY2JlYjZlNmZjNjBmLnVzZXIiLCJ0aW1lc2VyaWVzLnpvbmVzLjNiYzQ4ZjcwLTE1MTktNGIyNy1hNzEzLWNiZWI2ZTZmYzYwZi5xdWVyeSIsInVhYS5ub25lIiwidGltZXNlcmllcy56b25lcy4zYmM0OGY3MC0xNTE5LTRiMjctYTcxMy1jYmViNmU2ZmM2MGYuaW5nZXN0Il0sImNsaWVudF9pZCI6ImhhY2thdGhvblVBQSIsImNpZCI6ImhhY2thdGhvblVBQSIsImF6cCI6ImhhY2thdGhvblVBQSIsImdyYW50X3R5cGUiOiJjbGllbnRfY3JlZGVudGlhbHMiLCJyZXZfc2lnIjoiOTQxYTMyZTEiLCJpYXQiOjE0NzkyMzY3ODIsImV4cCI6MTQ3OTI3OTk4MiwiaXNzIjoiaHR0cHM6Ly9mZmE4MDg3Yy02YmVmLTRmODMtOWZmYi01YmU2N2ZjYWMzODgucHJlZGl4LXVhYS5ydW4uYXdzLXVzdzAyLXByLmljZS5wcmVkaXguaW8vb2F1dGgvdG9rZW4iLCJ6aWQiOiJmZmE4MDg3Yy02YmVmLTRmODMtOWZmYi01YmU2N2ZjYWMzODgiLCJhdWQiOlsidGltZXNlcmllcy56b25lcy4zYmM0OGY3MC0xNTE5LTRiMjctYTcxMy1jYmViNmU2ZmM2MGYiLCJoYWNrYXRob25VQUEiXX0.SiYEaMjxt-5AzKOO3tROC2kzFRckzHD21kzJ6Dbw8_WFJwGsjONQ4CyT4iaUEI6WiFDidPemrzA8V_7gylSNqGTz2oy647tT6UwUyPMTocNh_O9IrDerrmDpsrIl_1MzxFQMWqMbRtPopqPCE7I5L1HTxrLq3pjI1bsuhvsLsr_ep8q2fGZiwrJRLnKTRs3a961sYdu5WR353qn7wDmEoalGWYnHO_ei6PrUl-3NED77BtPX4IGQ-mpY0KnYgcX_ju0hhooRaUUi_DZJj770TG2R0A_M6UpzQNxR0wOqcGkUKy1XBAM3lYqA2b0c133QfA8Pja4NPlHQR6wA1zhktw",
                        "Predix-Zone-Id" : "3bc48f70-1519-4b27-a713-cbeb6e6fc60f"
                    }'
           body='{
                    "start" : "1y-ago",
                    "tags" : [
                          {
                            "name" : "Gas Gen - 9H2"
                          }
                      ]
                 }'
           handle-as="json"
           on-response="handleResponse">
        </iron-ajax>
    <px-card header-text="Block 1" icon="fa-bolt" chevron="true" on-click="_testLog" on-chevron-hit="_toggleCard">
      <div id="top-info">
        <div id="cost-output">
          <h2>Cost: $<span id="cost">180</span></h2>
          <h2>Output: <span id="output">400</span>mW</h2>
        </div>
        <div id="graph">
          <!--
          #### Series Object

              <px-chart-series-line id="my-series"
                series-obj-name-key="myName"
                series-obj-data-key="myData">
              </px-chart-series-line>

          ```js
            document.querySelector('#my-series').seriesObj = {
                    myData: [
                        [1397102460000, 11.4403],
                        [1397139660000, 13.1913],
                        [1397177400000, 12.8485],
                        [1397228040000, 10.975]],
                    myName: 'foo'
                };
          -->

          <px-chart height="200" margin="[10,10,10,10]" spacing-bottom="0">

          </px-chart>
        </div>
      </div>

      <div class="clear">
      </div>
      <div id="collapse" hidden="true">
        <h2 id="equipment">Equipment:</h2>

      <div id="gt1-blk1" class="block" >
        <div class="dropdown">
          <px-dropdown id="asset-dropdown" display-value="Gas Turbine - 7IEA">
            <px-dropdown-content extend-dropdown='true'
              extend-dropdown-by='25' max-cont-character-width='10'
              items='[{"key":"Gas Engine 1 - TS","val":"Gas Turbine - 7IEA"},{"key":"Gas Engine 2 - TS","val":"Gas Turbine - 7FB.04"},
              {"key":"Gas Engine 3 - TS","val":"Gas Turbine - 6FA.01"}]'>
            </px-dropdown-content>
          </px-dropdown>
        </div>
        <div id="specs">
          <p>Max Output: <span id="max-output">50</span>mW</p>
          <p>Frequency: <span id="frequency">60</span></p>
          <p>Ramp Rate: <span id="ramp-rate">5</span></p>
          <p>Minimum Load: <span id="minimum-load">25</span></p>
        </div>
      </div>

      <div id="gt2-blk1" class="block" >
        <div class="dropdown">
          <px-dropdown id="asset-dropdown" display-value="Gas Turbine - 7IEA">
            <px-dropdown-content extend-dropdown='true'
              extend-dropdown-by='25' max-cont-character-width='10'
              items='[{"key":"Gas Engine 1 - TS","val":"Gas Turbine - 7IEA"},{"key":"Gas Engine 2 - TS","val":"Gas Turbine - 7FB.04"},
              {"key":"Gas Engine 3 - TS","val":"Gas Turbine - 6FA.01"}]'>
            </px-dropdown-content>
          </px-dropdown>
        </div>
        <div id="specs">
          <p>Max Output: <span id="max-output">50</span>mW</p>
          <p>Frequency: <span id="frequency">60</span></p>
          <p>Ramp Rate: <span id="ramp-rate">5</span></p>
          <p>Minimum Load: <span id="minimum-load">25</span></p>
        </div>
      </div>

      <div id="gen1-blk1" class="block" >
        <div class="dropdown">
          <px-dropdown id="asset-dropdown" display-value="Gas Gen - 9H2">
            <px-dropdown-content extend-dropdown='true'
              extend-dropdown-by='25' max-cont-character-width='10'
              items='[{"key":"1","val":"Gas Gen - 9H2"},{"key":"2","val":"Gas Gen - 6A2"},{"key":"3","val":"Gas Gen - 7H2-IV"},
              {"key":"4","val":"Gas Gen - 9A4"}]'>
            </px-dropdown-content>
          </px-dropdown>
        </div>
        <div id="specs">
          <p>Max Output: <span id="max-output">50</span>mW</p>
          <p>Power Factor: <span id="power-factor">60</span></p>
        </div>
      </div>

      <div class="clear">
      </div>

      <button class="btn btn--primary" on-click="_sendData">Submit</button>
    </div>

    </px-card>
  </template>

  <script>
    Polymer({
      is: 'block-card-1',
      properties: {},
      getInitialData: function() {

          // grab all assets

          this.$.requestAllAssets.generateRequest(); // leaves results in this.$.assets
          // var assets = this.$.assets.tags;
          // random query using 3 (or so) assets as a "block" (make sure these are valid)

          // var asset1 = assets[0];
          // var asset2 = assets[1];
          // var asset3 = assets[2];

          //this.$.block = [asset1, asset2, asset3]; // access this in the getBlock function

          // get corresponding block + asset data
          //this.$.requestBlock.generateRequest(); // leaves results in this.$.block

          /*var dummyData = {
            "aggregatedTimeSeriesData": {
              "names": [
                "Steam Engine 1 - TS",
                "Steam Engine 2 - TS"
              ],
              "powerVals": [
                938,
                1031.8,
                886.1,
                938,
                989.9,
                979.9
              ]
            },
            "avgPowerData": [
              {
                "name": "Steam Engine 1 - TS",
                "avgPower": 518.37782217782
              },
              {
                "name": "Steam Engine 2 - TS",
                "avgPower": 418.03726273726
              }
            ],
            "maxPowerData": [
              {
                "name": "Steam Engine 1 - TS",
                "maxPower": 570.9
              },
              {
                "name": "Steam Engine 2 - TS",
                "maxPower": 460.9
              }
            ]
          };*/

          console.log(this.allAssets);
          
          // call update functions to show data on the page
      },
      // this function is used to fill the page with proper asset/block data from the db
      setData: function() {
          // get the data from the db
          // set the corresponding page elements
          var blockData = [2,2]; // dummy
          var numAssets = 0;
          for (var asset in blockData) {
            var parentDiv = document.createElement("div");
            parentDiv.id = "asset-" + numAssets; // create overarching div

            // create dropdown
            var dropdown = document.createElement("div");
            dropdown.class = "dropdown";

            // create px-dropdown
            var pxDropdown = document.createElement("px-dropdown");
            //pxDropdown.id = "asset-dropdown-"+numAssets;
            //console.log(pxDropdown.id);
            pxDropdown["display-value"] = "INSERT DATA HERE"; // name the asset // REPLACE THIS WITH DATA


            // add dropdown contents
            var pxDropdownContent = document.createElement("px-dropdown-content");
            pxDropdownContent.items = [{"key":"1","val":"Gas Turbine 1"},{"key":"2","val":"Gas Turbine 2"},{"key":"3","val":"Gas Turbine 3"},
            {"key":"4","val":"Gas Turbine 4"}]; // REPLACE THIS WITH DATA

            pxDropdownContent["extend-dropdown"] = true;

            console.log(pxDropdownContent.items);

            // add all elements to parentDiv
            pxDropdown.appendChild(pxDropdownContent);
            dropdown.appendChild(pxDropdown);
            console.log(dropdown.class);

            parentDiv.appendChild(dropdown);

            var specsDiv = document.createElement("div");
            specsDiv.class = "specs";

            var output = document.createElement("p");
            output.id = "max-output";
            output.innerHTML = "Max Output: " + "blockData.maxOutput";

            var frequency = document.createElement("p");
            frequency.id = "frequency";
            frequency.innerHTML = "Frequency: " + "blockData.frequency";

            var rampRate = document.createElement("p");
            rampRate.id = "ramp-rate";
            rampRate.innerHTML = "Ramp Rate: " + "blockData.rampRate";

            var minLoad = document.createElement("p");
            minLoad.id = "minimum-load";
            minLoad.innerHTML = "Minimum Load: " + "blockData.minLoad";

            // add all p elements to specsDiv
            specsDiv.appendChild(output);
            specsDiv.appendChild(frequency);
            specsDiv.appendChild(rampRate);
            specsDiv.appendChild(minLoad);

            // add specsDiv to parentDiv
            parentDiv.appendChild(specsDiv);

            var h2Div = this.$.equipment;
            // insert parentDiv after h2 "equipment"
            h2Div.parentNode.insertBefore(parentDiv, h2Div.nextSibling);

            numAssets++;
          }
      },
      ready: function() {
        console.log('partpicker-view ready()')
        //this.setData();
      },
      _sendData: function() {
        console.log(document.querySelector("#gt1-blk1 div px-dropdown").selectedKey);
        var selectedGt1 = document.querySelector("#gt1-blk1 div px-dropdown").selectedKey
        != '' ? document.querySelector("#gt1-blk1 div px-dropdown").selectedKey : "Gas Engine 1 - TS";
        var selectedGt2 = document.querySelector("#gt2-blk1 div px-dropdown").selectedKey
        != '' ? document.querySelector("#gt2-blk1 div px-dropdown").selectedKey : "Gas Engine 1 - TS";
        var selectedGen1 = document.querySelector("#gen1-blk1 div px-dropdown").selectedKey
        != '' ? document.querySelector("#gen1-blk1 div px-dropdown").selectedKey : 1;

        console.log("getData(" + selectedGt1 + "," + selectedGt2 + "," + selectedGen1 + ")");

        this._updateSpecsGT1(69,70,71,72);
        this._updateSpecsGT2(2,4,6,8);
        this._updateSpecsGen1(300,400,500);
        this._updateBlockCost(200000);
        this._updateBlockOutput(300000);
      },
      _updateSpecsGT1: function(maxOutput, frequency, rampRate, minimumLoad) {
        document.querySelector("#gt1-blk1 #specs #max-output").innerHTML = maxOutput;
        document.querySelector("#gt1-blk1 #specs #frequency").innerHTML = frequency;
        document.querySelector("#gt1-blk1 #specs #ramp-rate").innerHTML = rampRate;
        document.querySelector("#gt1-blk1 #specs #minimum-load").innerHTML = minimumLoad;
      },
      _updateSpecsGT2: function(maxOutput, frequency, rampRate, minimumLoad) {
        document.querySelector("#gt2-blk1 #specs #max-output").innerHTML = maxOutput;
        document.querySelector("#gt2-blk1 #specs #frequency").innerHTML = frequency;
        document.querySelector("#gt2-blk1 #specs #ramp-rate").innerHTML = rampRate;
        document.querySelector("#gt2-blk1 #specs #minimum-load").innerHTML = minimumLoad;
      },
      _updateSpecsGen1: function(maxOutput, powerFactor) {
        document.querySelector("#gen1-blk1 #specs #max-output").innerHTML = maxOutput;
        document.querySelector("#gen1-blk1 #specs #power-factor").innerHTML = powerFactor;
      },
      _updateBlockCost: function(cost) {
        document.querySelector("#cost-output #cost").innerHTML = cost;
      },
      _updateBlockOutput: function(output) {
        document.querySelector("#cost-output #output").innerHTML = output;
      },
      _testLog: function() {

      },
      _toggleCard: function() {
        console.log("collapse card");
        if (document.querySelector("#collapse").hasAttribute("hidden")) {
          document.querySelector("#collapse").removeAttribute("hidden");
        }
        else {
          document.querySelector("#collapse").setAttribute("hidden", "true");
        }
      }
    });
  </script>

</dom-module>
